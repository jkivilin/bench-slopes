#!/bin/bash

function get_machine() {
  echo "$1" | sed 's/^.*_on_\(.*\)\.csv$/\1/g'
}
function get_libname() {
  echo "$1" | sed 's/^\(.*\)_results_for_cipher_.*$/\1/g'
}
function get_dataname() {
  echo "$1" | sed 's/^.*_results_for_cipher_\(.*\)_on_.*\.csv$/\1/g'
}

function output_gnuplot_script() {
  local outfile="$1"
  local -n infiles=$2

  if [ -e "results_$outfile.pdf" ]; then
    rm "results_$outfile.pdf"
  fi

  echo "set terminal pdf noenhanced solid size 5.0, 3.5"
  echo "set output 'results_$outfile.pdf'"
  echo "set xrange [10:2200000]"
  echo "set format x \"%.0f\""

  echo "set datafile separator \",\""

  echo "set xtics rotate by -20 font \",8\""
  echo "set ytics font \",8\""

  ### Plot (mebibytes per second at 2Ghz)/data length ###

  echo "set title \"Speed by Data Length (at 2 Ghz)\""
  echo "set xlabel \"Data Length in Bytes\""
  echo "set ylabel \"Mebibyte / Second\""
  echo "set logscale x 2"
  echo "unset logscale y"
  echo "set key below font \",8\""

  echo -n "plot "
  local first=1
  for file in "${infiles[@]}"; do
    local libname=$(get_libname $file)
    local machine=$(get_machine $file)
    local dataname=$(get_dataname $file)

    if [ $first != 1 ]; then
      echo -n ","
    fi
    first=0

    echo -n "\"$file\" using 1:((2*1000*1000*1000) / (\$3 * (1024*1024))) title \"$libname/$dataname/$machine\"" with errorlines pointtype 0
  done
  echo ""

  ### Plot cycles/data length ###

  echo "set title \"Absolute Cycles by Data Length\""
  echo "set xlabel \"Data Length in Bytes\""
  echo "set ylabel \"Cycles\""
  echo "set logscale x 2"
  echo "set logscale y"
  echo "set key below font \",8\""

  echo -n "plot "
  local first=1
  for file in "${infiles[@]}"; do
    local libname=$(get_libname $file)
    local machine=$(get_machine $file)
    local dataname=$(get_dataname $file)

    if [ $first != 1 ]; then
      echo -n ","
    fi
    first=0

    echo -n "\"$file\" using 1:2 title \"$libname/$dataname/$machine\"" with errorlines pointtype 0
  done
  echo ""

  ### Plot (cycles per byte)/data length ###

  echo "set title \"Cycles per Byte by Data Length\""
  echo "set xlabel \"Data Length in Bytes\""
  echo "set ylabel \"Cycles per Byte\""
  echo "set logscale x 2"
  echo "set logscale y"
  echo "set key below font \",8\""

  echo -n "plot "
  local first=1
  for file in "${infiles[@]}"; do
    local libname=$(get_libname $file)
    local machine=$(get_machine $file)
    local dataname=$(get_dataname $file)

    if [ $first != 1 ]; then
      echo -n ","
    fi
    first=0

    echo -n "\"$file\" using 1:3 title \"$libname/$dataname/$machine\"" with errorlines pointtype 0
  done
  echo ""
}

function do_plot() {
  local topic="$1"
  local ign="$2"
  local mode="$3"
  shift
  shift
  shift
  local arr=("$@")
  files=()
  for match in "${arr[@]}"; do
    for fname in *_results_for_cipher_$match$mode*.csv; do
      local okname=$(grep -v -- "$ign" <<< "$fname")
      if [ "x$ign" != "x" ] && [ "x$okname" = "x" ]; then
	continue
      fi
      if [ -e "$fname" ]; then
	files+=("$fname")
      fi
    done
  done
  if [ "${#files[@]}" -gt "0" ]; then
    output_gnuplot_script "$topic" files | gnuplot
  fi
}

function plot_blockcipher() {
  local bcipher="$1"
  shift
  local array=("$@")

  do_plot "$bcipher-CBC" "" "_CBC" "${array[@]}"
  do_plot "$bcipher-CFB" "" "_CFB" "${array[@]}"
  do_plot "$bcipher-XTS" "" "_XTS" "${array[@]}"
  do_plot "$bcipher-CTR" "-dec_" "_CTR" "${array[@]}"
  do_plot "$bcipher-GCM" "-auth_" "_GCM" "${array[@]}"
  do_plot "$bcipher-CCM" "-auth_" "_CCM" "${array[@]}"
  do_plot "$bcipher-EAX" "-auth_" "_EAX" "${array[@]}"
  do_plot "$bcipher-OCB" "-auth_" "_OCB" "${array[@]}"
}

plot_blockcipher "AES128" AES-128 aes-128 aes128 AES &
plot_blockcipher "AES256" AES-256 aes-256 aes256 AES256 &
plot_blockcipher "Camellia128" camellia-128 camellia128 Camellia-128 CAMELLIA128 &
plot_blockcipher "Camellia256" camellia-256 camellia256 Camellia-256 CAMELLIA256 &
plot_blockcipher "Twofish" twofish128 Twofish TWOFISH128 &
plot_blockcipher "Serpent" serpent128 Serpent SERPENT128 &
plot_blockcipher "SEED" seed SEED &
plot_blockcipher "3DES" des-ede3 des3 3DES &
plot_blockcipher "Blowfish" bf blowfish Blowfish BLOWFISH &
plot_blockcipher "CAST5" cast5 cast128 CAST-128 CAST5 &

do_plot "RC4" "STREAM-dec_" "_STREAM" rc4 RC4 arcfour ARCFOUR &
do_plot "ChaCha20" "STREAM-dec_" "_STREAM" chacha20 chacha CHACHA20 ChaCha &
do_plot "ChaCha20-Poly1305" "-auth_" "_POLY1305" chacha20 chacha CHACHA20 ChaCha &

wait
